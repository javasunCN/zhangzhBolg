---
layout: post
title:  "[Lucene]索引文件格式"
date:   2019-11-1 20:00:00 +0800
tags: Lucene
color: rgb(0,0,0)
cover: 'https://github.com/javasunCN/zhangzhBolg/blob/master/assets/img/Lucene.png?raw=true'
subtitle: 'Apache Lucene - Index File Formats'
---

> Lucene索引里面存放什么，如何存放，即Lucene的索引文件格式<br/>
> Lucene的索引文件格式是读懂Lucene源码的一把钥匙

## Lucene工作原理
* 索引流程

> 采集数据构建文档对象分析文档(分词)创建索引<br/>
> 数据采集源(文件、数据库、网络等) -> 分词 -> 创建索引目录、索引对象<br/>
> 采集的数据，封装成各种Field，把Field再封装成document，对document进行分析(对字段分词),生成索引目录以及document写入文档信息库

* 搜索流程

> 用户通过搜索界面创建查询执行搜索，搜索器从索引库搜索渲染搜索结果<br/>
> 输入查询文本，根据关键词解析(queryParser)出查询条件(query)，利用搜索工具(indexSearcher)去索引库中获取文档id,
> 然后再根据文档id去文档信息库获取文档信息<br/>

* 相关度得分

> 1).建立索引的时候，可以给指定文档的指定域设置一个权重<br/>
> 2).在搜索时，可以给不同的搜索域设置不同权重

## Lucene索引的层次结构

- 索引(Index)
    - 在Lucene中一个索引是放在一个文件夹中的
    - 同一文件夹中的所有的文件构成一个Lucene索引
- 段(Segment)
    - 一个索引可以包含多个段，段与段之间是独立的，添加新文档可以生成新的段，不同的段可以合并
    - 具有相同前缀文件的属同一个段，例如: 文件开头 "_0" 和 "_1"属于两个段
    - segments.gen和segments_5是段的元数据文件，也即它们保存了段的属性信息
- 文档(Document)
    - 文档是我们建索引的基本单位，不同的文档是保存在不同的段中的，一个段可以包含多篇文档
    - 新添加的文档是单独保存在一个新生成的段中，随着段的合并，不同的文档合并到同一个段中
- 域(Field)
    - 一篇文档包含不同类型的信息，可以分开索引，比如标题，时间，正文，作者等，都可以保存在不同的域里
    - 不同域的索引方式可以不同，在真正解析域的存储的时候进行详细分析
- 词(Term)
    - 词是索引的最小单位，是经过词法分析和语言处理后的字符串
    

## Lucene索引结构

### 正向索引

- 按层次，保存索引到词的包含关系：索引(Index) –> 段(Segment) –> 文档(Document) –> 域(Field) –> 词(Term)
- 解释:此索引(Index)包含哪些段(Segment)，每段(Segment)包含哪些文档(Document)，每个文档(Document)包含哪些域(Field)，每个域(Field)包含哪些词(Term)
- 按层次，每个层次都保存了本层次的信息以及下一层次元信息，即属性信息，例如:中国包含多少个省，每个省包含了多少市的元数据
- 包含正向信息的文件

| 文件类型 | 文件后缀 | 描述 |
|:--------|:-------:|:--------|
| 段(Segment)   | segments.gen, segments_N   | 保存了此索引包含多少个段，每个段包含多少篇文档。   |
|----
| 域(Field)   | .fnm   | 	存储有关字段的信息   |
|----
| 域索引(Field Index)   | .fdx   | 	包含指向字段数据的指针  |
|----
| 域数据(Field Data)   | .fdt   | 文档的存储字段   |
|----
| 词向量索引(Term Vector Index)   | .tvx   | 将偏移量存储到文档数据文件中   |
|----
| 词向量文档(Term Vector Documents)   | .tvd   | 包含有关每个具有词语向量的文档的信息   |
|----
| 词向量域(Term Vector Fields)   | .tvf   | 有关词语向量的字段级别信息   |



### 反向索引

- 保存了词典到倒排表的映射：词(Term) –> 文档(Document)
- 包含反向信息的文件

| 文件类型 | 文件后缀 | 描述 |
|:--------|:-------:|:--------|
| 词信息(Term Infos)   | .tis   | 词语词典的一部分，存储词语信息  |
|----
| 词信息索引(Term Info Index)    | .tii   | 	词语信息文件索引   |
|----
| (Frequencies)   | .frq   | 	保存了倒排表，也即包含每个词的文档ID列表 包含文档列表，其中包含每个词语以及词频率   |
|----
| (Positions)   | .prx   | 	保存了倒排表中每个词在包含此词的文档中的位置 |



### 基本类型

- Byte：是最基本的类型，长8位(bit)
- UInt32：由4个Byte组成
- Uint64：由8个Byte组成
- VInt：
    - 变长的整数类型，它可能包含多个Byte，对于每个Byte的8位，其中后7位表示数值，最高1位表示是否还有另一个Byte，0表示没有，1表示有
    - 越前面的Byte表示数值的低位，越后面的Byte表示数值的高位。
    - 例如130化为二进制为 1000, 0010，总共需要8位，一个Byte表示不了，因而需要两个Byte来表示，
      第一个Byte表示后7位，并且在最高位置1来表示后面还有一个Byte，所以为(1) 0000010，第二个Byte表示第8位，
      并且最高位置0来表示后面没有其他的Byte了，所以为(0) 0000001。
- Chars：是UTF-8编码的一系列Byte
- String：一个字符串首先是一个VInt来表示此字符串包含的字符的个数，接着便是UTF-8编码的字符序列Chars。


### 基本规则

> Lucene为了使的信息的存储占用的空间更小，访问速度更快，采取了一些特殊的技巧

- 前缀后缀规则(Prefix+Suffix)

> 所谓前缀后缀规则，即当某个词和前一个词有共同的前缀的时候，后面的词仅仅保存前缀在词中的偏移(offset)，以及除前缀以外的字符串(称为后缀)

```textmate
    Lucene在反向索引中，要保存词典(Term Dictionary)的信息，所有的词(Term)在词典中是按照字典顺序进行排列的，
然而词典中包含了文档中的几乎所有的词，并且有的词还是非常的长的，这样索引文件会非常的大

    比如要存储如下词:term，termagancy，termagant，terminal，
    
    如果按照正常方式来存储，需要的空间如下：
    
    [VInt = 4] [t][e][r][m]，[VInt = 10][t][e][r][m][a][g][a][n][c][y]，[VInt = 9][t][e][r][m][a][g][a][n][t]，[VInt = 8][t][e][r][m][i][n][a][l]
    
    共需要35个Byte.
    
    如果应用前缀后缀规则，需要的空间如下：
    
    [VInt = 4] [t][e][r][m]，[VInt = 4 (offset)][VInt = 6][a][g][a][n][c][y]，[VInt = 8 (offset)][VInt = 1][t]，[VInt = 4(offset)][VInt = 4][i][n][a][l]
    
    共需要22个Byte。
    
    大大缩小了存储空间，尤其是在按字典顺序排序的情况下，前缀的重合率大大提高。
```

- 差值规则(Delta)

> 所谓差值规则(Delta)就是先后保存两个整数的时候，后面的整数仅仅保存和前面整数的差即可。

```textmate
    在Lucene的反向索引中，需要保存很多整型数字的信息，比如文档ID号，比如词(Term)在文档中的位置等等。
    整型数字是以VInt的格式存储的。随着数值的增大，每个数字占用的Byte的个数也逐渐的增多。
    
    比如要存储如下整数：16386，16387，16388，16389
    
    如果按照正常方式来存储，需要的空间如下：
    
    [(1) 000, 0010][(1) 000, 0000][(0) 000, 0001]，[(1) 000, 0011][(1) 000, 0000][(0) 000, 0001]，[(1) 000, 0100][(1) 000, 0000][(0) 000, 0001]，[(1) 000, 0101][(1) 000, 0000][(0) 000, 0001]
    
    供需12个Byte。
    
    如果应用差值规则来存储，需要的空间如下：
    
    [(1) 000, 0010][(1) 000, 0000][(0) 000, 0001]，[(0) 000, 0001]，[(0) 000, 0001]，[(0) 000, 0001]
    
    共需6个Byte。
    
    大大缩小了存储空间，而且无论是文档ID，还是词在文档中的位置，都是按从小到大的顺序，逐渐增大的。
```

- 或然跟随规则(A, B?)



- 跳跃表规则(Skip list) 







#### 附录：文件扩展名

| 文件类型 | 文件后缀 | 描述 |
|:--------|:-------:|:--------|
| Segments File  | segments.gen, segments_N   | 存储关于段的信息  |
|----
| Lock File    | write.lock   |  写入锁定可防止多个IndexWriters写入同一文件。  |
|----
| Compound File   | .cfs   | 	可选的“虚拟”文件，由所有其他索引文件组成，用于经常用尽文件句柄的系统。  |
|----
| Fields   | .fnm   | 	存储有关字段的信息   |
|----
| Field Index   | 	.fdx   |  包含指向字段数据的指针  |
|----
| Field Data   | .fdt   | 	文档的存储字段   |
|----
| Term Infos   | .tis   | 	词语词典的一部分，存储词语信息   |
|----
| Term Info Index   | .tii  | 	词语信息文件索引   |
|----
| Frequencies   | .frq   | 	包含文档列表，其中包含每个词语以及词频率   |
|----
| Positions   |  .prx   | 	存储有关词语在索引中出现的位置信息   |
|----
| Norms   |  .nrm   | 	编码文档和字段的长度以及提升因子   |
|----
| Term Vector Index  | .tvx   | 	将偏移量存储到文档数据文件中   |
|----
| Term Vector Documents   | .tvd   | 	包含有关每个具有词语向量的文档的信息   |
|----
| Term Vector Fields  | .tvf   | 	有关词语向量的字段级别信息   |
|----
| Deleted Documents   | .del   | 	有关删除哪些文件的信息  |












